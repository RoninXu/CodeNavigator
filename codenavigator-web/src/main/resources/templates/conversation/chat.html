<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: html(pageTitle='AI学习助手 - CodeNavigator', showSidebar=false, activeNav='conversation')}">
<head>
    <th:block th:fragment="styles">
        <style>
            /* AI助手对话界面特定样式 */
            .chat-container {
                height: calc(100vh - 200px);
                min-height: 600px;
                background: white;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-md);
                border: 1px solid var(--border-color);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .chat-header {
                background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
                color: white;
                padding: 1.5rem;
                border-radius: var(--border-radius) var(--border-radius) 0 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
                background: var(--light-bg);
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .chat-input-area {
                padding: 1rem;
                background: white;
                border-top: 1px solid var(--border-color);
                border-radius: 0 0 var(--border-radius) var(--border-radius);
            }

            .message {
                display: flex;
                align-items: flex-start;
                gap: 0.75rem;
                animation: fadeInUp 0.3s ease;
                max-width: 100%;
                margin-bottom: 1rem;
            }

            .message.user {
                flex-direction: row-reverse;
            }

            .message-avatar {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                color: white;
                font-size: 1rem;
                flex-shrink: 0;
            }

            .message.user .message-avatar {
                background: linear-gradient(135deg, var(--success-color) 0%, #047857 100%);
            }

            .message.bot .message-avatar {
                background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            }

            .message-content {
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 1rem;
                padding: 1rem 1.25rem;
                max-width: 70%;
                position: relative;
                box-shadow: var(--shadow-sm);
                word-wrap: break-word;
                line-height: 1.6;
            }

            .message.user .message-content {
                background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
                color: white;
                border-color: var(--primary-color);
            }

            .message.bot .message-content {
                background: white;
                border-color: var(--border-color);
            }

            .message-content::before {
                content: '';
                position: absolute;
                top: 1rem;
                width: 0;
                height: 0;
                border: 8px solid transparent;
            }

            .message.user .message-content::before {
                right: -15px;
                border-left-color: var(--primary-color);
            }

            .message.bot .message-content::before {
                left: -15px;
                border-right-color: white;
            }

            .message-time {
                font-size: 0.75rem;
                color: var(--text-muted);
                margin-top: 0.25rem;
                text-align: center;
            }

            .message.user .message-time {
                color: rgba(255, 255, 255, 0.8);
            }

            .input-group {
                gap: 0.5rem;
            }

            .chat-input {
                border: 2px solid var(--border-color);
                border-radius: 25px;
                padding: 0.75rem 1.25rem;
                resize: none;
                font-size: 0.95rem;
                transition: all 0.3s ease;
                min-height: 50px;
                max-height: 150px;
            }

            .chat-input:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
            }

            .send-button {
                background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
                color: white;
                border: none;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.1rem;
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .send-button:hover {
                transform: scale(1.05);
                box-shadow: var(--shadow-md);
            }

            .send-button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .send-button.loading {
                animation: pulse 1.5s infinite;
            }

            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }

            /* 打字指示器 */
            .typing-indicator {
                display: none;
                align-items: center;
                gap: 0.5rem;
                padding: 1rem;
                color: var(--text-muted);
                font-style: italic;
            }

            .typing-dots {
                display: flex;
                gap: 4px;
            }

            .typing-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background-color: var(--primary-color);
                animation: typing 1.4s infinite;
            }

            .typing-dot:nth-child(2) {
                animation-delay: 0.2s;
            }

            .typing-dot:nth-child(3) {
                animation-delay: 0.4s;
            }

            @keyframes typing {
                0%, 60%, 100% {
                    transform: scale(1);
                    opacity: 0.4;
                }
                30% {
                    transform: scale(1.3);
                    opacity: 1;
                }
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* 建议消息 */
            .suggested-messages {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }

            .suggested-message {
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 20px;
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
                cursor: pointer;
                transition: all 0.3s ease;
                color: var(--primary-color);
            }

            .suggested-message:hover {
                background: var(--primary-color);
                color: white;
                transform: translateY(-1px);
                box-shadow: var(--shadow-sm);
            }

            /* 响应式设计 */
            @media (max-width: 768px) {
                .chat-container {
                    height: calc(100vh - 150px);
                    margin: 0.5rem 0;
                }

                .message-content {
                    max-width: 85%;
                }

                .message-avatar {
                    width: 2rem;
                    height: 2rem;
                    font-size: 0.875rem;
                }

                .chat-input {
                    border-radius: 20px;
                    padding: 0.6rem 1rem;
                }

                .send-button {
                    width: 40px;
                    height: 40px;
                    font-size: 1rem;
                }
            }
        </style>
    </th:block>
</head>

<body>
    <th:block th:fragment="content">
        <div class="chat-container">
            <div class="chat-header">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-robot me-2 fs-5"></i>
                        <div>
                            <h5 class="mb-0">CodeNavigator AI助手</h5>
                            <small class="opacity-75">您的专属编程学习导师</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-outline-light btn-sm" onclick="clearChat()" title="清空对话">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="toggleInfo()" title="帮助信息">
                            <i class="bi bi-info-circle"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- 欢迎消息 -->
                <div class="message bot">
                    <div class="message-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-content">
                        <p class="mb-2">👋 您好！我是CodeNavigator的AI学习助手。</p>
                        <p class="mb-2">我可以帮助您：</p>
                        <ul class="mb-2">
                            <li>🎯 制定个性化学习计划</li>
                            <li>🔍 分析和解释代码</li>
                            <li>💡 提供编程建议和最佳实践</li>
                            <li>🐛 协助调试和问题解决</li>
                            <li>📚 推荐学习资源和路径</li>
                        </ul>
                        <p class="mb-0">有什么编程问题想要讨论吗？</p>
                        <div class="message-time">刚刚</div>
                    </div>
                </div>

                <!-- 建议消息 -->
                <div class="suggested-messages">
                    <div class="suggested-message" onclick="sendSuggestedMessage('我想学习Java编程，应该从哪里开始？')">
                        我想学习Java编程
                    </div>
                    <div class="suggested-message" onclick="sendSuggestedMessage('请帮我分析这段代码的时间复杂度')">
                        分析代码复杂度
                    </div>
                    <div class="suggested-message" onclick="sendSuggestedMessage('如何优化数据库查询性能？')">
                        数据库优化建议
                    </div>
                    <div class="suggested-message" onclick="sendSuggestedMessage('Spring Boot项目的最佳实践有哪些？')">
                        Spring Boot最佳实践
                    </div>
                </div>

                <!-- 打字指示器 -->
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div>
                        AI正在思考
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="input-group">
                    <textarea
                        class="form-control chat-input"
                        id="messageInput"
                        placeholder="输入您的问题或代码..."
                        rows="1"
                        style="resize: none;"></textarea>
                    <button class="send-button" id="sendButton" type="button">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
                <small class="text-muted mt-2 d-block">
                    <i class="bi bi-lightbulb me-1"></i>
                    提示：您可以粘贴代码片段，AI会帮您分析和改进
                </small>
            </div>
        </div>
    </th:block>

    <th:block th:fragment="scripts">
        <script>
            class ChatInterface {
                constructor() {
                    this.messages = document.getElementById('chatMessages');
                    this.messageInput = document.getElementById('messageInput');
                    this.sendButton = document.getElementById('sendButton');
                    this.typingIndicator = document.getElementById('typingIndicator');
                    this.sessionId = this.generateSessionId();

                    this.initEventListeners();
                    this.adjustTextareaHeight();
                }

                generateSessionId() {
                    return 'chat_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                }

                initEventListeners() {
                    this.sendButton.addEventListener('click', () => this.sendMessage());

                    this.messageInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });

                    this.messageInput.addEventListener('input', () => {
                        this.adjustTextareaHeight();
                    });
                }

                adjustTextareaHeight() {
                    this.messageInput.style.height = 'auto';
                    this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 150) + 'px';
                }

                async sendMessage() {
                    const message = this.messageInput.value.trim();
                    if (!message) return;

                    // 添加用户消息
                    this.addMessage(message, 'user');
                    this.messageInput.value = '';
                    this.adjustTextareaHeight();
                    this.setInputEnabled(false);
                    this.showTypingIndicator();

                    try {
                        // 发送消息到后端
                        const response = await fetch('/api/conversation/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                message: message,
                                sessionId: this.sessionId
                            })
                        });

                        if (!response.ok) {
                            throw new Error('网络请求失败');
                        }

                        const data = await response.json();

                        // 添加AI回复
                        setTimeout(() => {
                            this.hideTypingIndicator();
                            this.addMessage(data.response || '抱歉，我现在无法处理您的请求。', 'bot');
                            this.setInputEnabled(true);
                            this.messageInput.focus();
                        }, 1000);

                    } catch (error) {
                        console.error('发送消息失败:', error);
                        this.hideTypingIndicator();
                        this.addMessage('抱歉，发生了网络错误，请稍后再试。', 'bot');
                        this.setInputEnabled(true);
                        this.messageInput.focus();
                    }
                }

                addMessage(content, type) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${type}`;

                    const currentTime = new Date().toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    messageDiv.innerHTML = `
                        <div class="message-avatar">
                            <i class="bi bi-${type === 'user' ? 'person-fill' : 'robot'}"></i>
                        </div>
                        <div class="message-content">
                            ${this.formatMessage(content)}
                            <div class="message-time">${currentTime}</div>
                        </div>
                    `;

                    // 插入到打字指示器之前
                    this.messages.insertBefore(messageDiv, this.typingIndicator);
                    this.scrollToBottom();
                }

                formatMessage(content) {
                    // 简单的消息格式化，支持代码块和链接
                    return content
                        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                        .replace(/`([^`]+)`/g, '<code>$1</code>')
                        .replace(/\n/g, '<br>')
                        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
                }

                scrollToBottom() {
                    this.messages.scrollTop = this.messages.scrollHeight;
                }

                showTypingIndicator() {
                    this.typingIndicator.style.display = 'flex';
                    this.scrollToBottom();
                }

                hideTypingIndicator() {
                    this.typingIndicator.style.display = 'none';
                }

                setInputEnabled(enabled) {
                    this.messageInput.disabled = !enabled;
                    this.sendButton.disabled = !enabled;

                    if (enabled) {
                        this.sendButton.classList.remove('loading');
                        this.sendButton.innerHTML = '<i class="bi bi-send-fill"></i>';
                    } else {
                        this.sendButton.classList.add('loading');
                        this.sendButton.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
                    }
                }
            }

            // 全局函数
            function sendSuggestedMessage(message) {
                if (window.chatInterface) {
                    window.chatInterface.messageInput.value = message;
                    window.chatInterface.sendMessage();
                }
            }

            function clearChat() {
                if (confirm('确定要清空对话记录吗？')) {
                    location.reload();
                }
            }

            function toggleInfo() {
                alert('CodeNavigator AI助手使用提示：\n\n1. 输入编程相关问题获取专业建议\n2. 可以粘贴代码片段进行分析\n3. 支持多种编程语言和技术栈\n4. 提供个性化学习路径规划\n\n如需更多帮助，请访问帮助中心。');
            }

            // 初始化聊天界面
            document.addEventListener('DOMContentLoaded', () => {
                window.chatInterface = new ChatInterface();
                window.chatInterface.messageInput.focus();
            });
        </script>
    </th:block>
</body>
</html>